global:
  # slack_api_url: ''

templates:
  - '/config/*.tmpl'

receivers:
  - name: devnull
  - name: 'Telegram Bot Alert'
    telegram_configs:
    - api_url: https://api.telegram.org
      bot_token: '7427610441:AAEXu_lh6F_JRtNdWsf4DloHD3rNd-3Xan0'
      chat_id: -100221246265
      send_resolved: true
      message: '{{ template "telegram.deployment.resource" . }}'

route:
  group_wait: 10s
  group_interval: 5m
  receiver: devnull
  repeat_interval: 3h
  group_by: 
    - deployment

  routes: 
    - match:
        alertname: DeploymentReachingMemoryLimit
      receiver: 'Telegram Bot Alert'

templates: 
alertmanager.tmpl: |
  {{ define "telegram_deployment_resource" }}
  {{ if eq .Status "firing" }}{{ range .Alerts }}
  ðŸªª <b>{{ .Labels.alertname }}</b>
  ---
  ðŸ”¥ {{ .Annotations.message }} 
  ðŸ“– Severity: <code>{{ .Labels.severity}}</code>
  âœ¨ Cluster: <code>{{ .Labels.cluster }}</code>
  ðŸŒŒ Namespace: <code>{{ .Labels.namespace }}</code>
  ðŸ›  <a href="http://127.0.0.1:8090/d/garysdevil-kube-state-metrics-v2/kubernetes-dashboard?orgId=1&var-cluster={{ .Labels.cluster }}&var-node=All&var-namespace={{ .Labels.namespace }}&var-datasource=vmcluster&var-deployment={{ .Labels.deployment }}">Grafana</a> ðŸ› 
  {{ end }}

  {{ else }}{{ range .Alerts }}
  âœ… {{ .Annotations.resolved }} âœ…
  Cluster: <b>{{ .Labels.cluster }}</b>
  Namespace: <b>{{ .Labels.namespace }}</b>
  {{ end }}

  {{ end }}
  {{ end }}